services:
  python-server-7000:
    image: python:3
    command: python -m http.server 7000
    ports:
      - "7000:7000"
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://localhost:7000', timeout=2)"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  python-server-8000:
    image: python:3
    command: python -m http.server 8000
    ports:
      - "8000:8000"
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import urllib.request; urllib.request.urlopen('http://localhost:8000', timeout=2)"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  go-https-fileserver:
    image: golang:1.24.4
    working_dir: /app
    command: >
      go run . -http-port 9000 -http2-port 9100 -tcp-port 9200 -tls
    ports:
      - "9000:9000"
      - "9100:9100"
      - "9200:9200"
    volumes:
      - ./file-server:/app
    healthcheck:
      test:
        - CMD
        - wget
        - --spider
        - --no-check-certificate
        - https://localhost:9000/
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  mock-assistant:
    image: node:20
    command: node /app/mock-assistant.js
    volumes:
      - ./mock-assistant:/app
    ports:
      - "3000:3000"
    environment:
      - DATA_PATH=/app/creds.json
    healthcheck:
      test:
        - CMD-SHELL
        - >
          node -e "const http=require('http');const req=http.request({method:'POST',hostname:'localhost',port:3000,path:'/chat'},res=>process.exit(res.statusCode===200?0:1));req.on('error',()=>process.exit(1));req.end();"
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  caller:
    image: curlimages/curl:latest
    command: sh /app/caller.sh
    volumes:
      - ./caller:/app
    depends_on:
      go-https-fileserver:
        condition: service_healthy
      python-server-7000:
        condition: service_healthy
      python-server-8000:
        condition: service_healthy
      mock-assistant:
        condition: service_healthy

